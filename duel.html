<!DOCTYPE html>
<html lang="ka">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tilo.ge - ‚öîÔ∏è ·Éì·É£·Éî·Éö·Éò</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="ratings.css">
    <style>
        body {
            background: #050505;
            flex-direction: column;
            overflow: hidden;
        }

        .duel-container {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        .duel-split {
            flex: 1;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .duel-side-left {
            border-right: 2px solid var(--primary, #ffd700);
        }

        .duel-side-right {
            border-left: 2px solid var(--primary, #ffd700);
        }

        /* HUD for Duel */
        .duel-hud {
            position: absolute;
            top: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 1000;
            pointer-events: none;
        }

        .duel-status-bar {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 10px 30px;
            border-radius: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 40px;
            align-items: center;
        }

        .duel-score-box {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .duel-score-box span {
            font-size: 0.7rem;
            opacity: 0.6;
            text-transform: uppercase;
        }

        .duel-score-box strong {
            font-size: 1.5rem;
            color: #ffd700;
        }

        .duel-timer {
            font-size: 2rem;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        /* Split Line */
        .duel-divider {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, transparent, #ffd700, transparent);
            z-index: 500;
            box-shadow: 0 0 20px #ffd700;
        }

        /* Player Names */
        .player-label {
            position: absolute;
            bottom: 30px;
            left: 30px;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.9rem;
            z-index: 1000;
        }

        /* Mobile Layout */
        @media (max-width: 800px) {
            .duel-container {
                flex-direction: column;
            }

            .duel-divider {
                left: 0;
                right: 0;
                top: 50%;
                bottom: auto;
                width: 100%;
                height: 4px;
                background: linear-gradient(to right, transparent, #ffd700, transparent);
            }

            .duel-side-left {
                border-right: none;
                border-bottom: 2px solid #ffd700;
            }

            .duel-side-right {
                border-left: none;
                border-top: 2px solid #ffd700;
            }
        }

        .canvas-side {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .duel-exit {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 2000;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .winner-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            animation: fadeIn 0.5s;
        }

        .winner-title {
            font-size: 3rem;
            font-weight: 800;
            color: #ffd700;
            margin-bottom: 20px;
        }

        .winner-reward {
            font-size: 1.5rem;
            opacity: 0.8;
        }
    </style>
</head>

<body class="theme-dark">
    <button class="duel-exit" onclick="exitDuel()">üè†</button>

    <div class="duel-hud">
        <div class="duel-status-bar">
            <div class="duel-score-box">
                <span id="p1-name">Player 1</span>
                <strong id="p1-score-display">0</strong>
            </div>
            <div class="duel-timer" id="duel-timer">05:00</div>
            <div class="duel-score-box">
                <span id="p2-name">Player 2</span>
                <strong id="p2-score-display">0</strong>
            </div>
        </div>
    </div>

    <div class="duel-container">
        <div class="duel-side-left" id="p1-area">
            <div class="canvas-side" id="p1-canvas"></div>
            <div class="player-label" id="p1-label">·Éõ·Éù·Éó·Éê·Éõ·Éê·É®·Éî 1</div>
        </div>

        <div class="duel-divider"></div>

        <div class="duel-side-right" id="p2-area">
            <div class="canvas-side" id="p2-canvas"></div>
            <div class="player-label" id="p2-label">·Éõ·Éù·Éó·Éê·Éõ·Éê·É®·Éî 2</div>
        </div>
    </div>

    <div id="winner-modal" class="winner-overlay hidden">
        <div class="winner-title" id="winner-text">·Éí·Éê·Éõ·Éê·É†·ÉØ·Éï·Éî·Éë·É£·Éö·Éò!</div>
        <div class="winner-reward" id="winner-reward-text">·Éû·É†·Éò·Éñ·Éò: 0 ü™ô</div>
        <button class="glass-btn" onclick="exitDuel()" style="margin-top: 30px;">·Éõ·Éó·Éê·Éï·Éê·É† ·Éõ·Éî·Éú·Éò·É£·É®·Éò ·Éì·Éê·Éë·É†·É£·Éú·Éî·Éë·Éê</button>
    </div>

    <div id="cloth" class="cloth" style="position: fixed; z-index: 3000;"></div>

    <script type="module">
        import { neon } from 'https://cdn.jsdelivr.net/npm/@neondatabase/serverless@0.9.4/+esm';
        const sql = neon("postgresql://neondb_owner:npg_NBPsUe3FXb4o@ep-calm-wildflower-aim8iczt-pooler.c-4.us-east-1.aws.neon.tech/neondb?sslmode=require");

        const params = new URLSearchParams(window.location.search);
        const duelId = params.get('id');
        const userEmail = localStorage.getItem('tilo_email');
        const userNick = localStorage.getItem('tilo_nick');

        if (!duelId || !userEmail) window.location.href = 'index.html';

        let duelData = null;
        let isPlayer1 = false;
        let p1Score = 0;
        let p2Score = 0;
        let timeLeft = 300; // 5 minutes
        let duelActive = false;
        let lastSync = 0;

        const get = id => document.getElementById(id);

        async function initDuel() {
            try {
                const res = await sql`SELECT * FROM duels WHERE id = ${duelId}`;
                if (res.length === 0) return window.location.href = 'index.html';

                duelData = res[0];
                isPlayer1 = (userEmail === duelData.player1_email);

                // Set names
                const p1Row = await sql`SELECT nickname FROM users WHERE email = ${duelData.player1_email}`;
                const p2Row = await sql`SELECT nickname FROM users WHERE email = ${duelData.player2_email}`;

                get('p1-name').textContent = p1Row[0].nickname;
                get('p2-name').textContent = p2Row[0].nickname;
                get('p1-label').textContent = p1Row[0].nickname;
                get('p2-label').textContent = p2Row[0].nickname;

                duelActive = true;
                startTimer();
                spawnStainsLoop();
                syncLoop();
            } catch (e) {
                console.error(e);
            }
        }

        function startTimer() {
            const int = setInterval(() => {
                if (!duelActive) return clearInterval(int);
                timeLeft--;
                const m = Math.floor(timeLeft / 60);
                const s = timeLeft % 60;
                get('duel-timer').textContent = `${m}:${s < 10 ? '0' : ''}${s}`;

                if (timeLeft <= 0) {
                    clearInterval(int);
                    finishDuel();
                }
            }, 1000);
        }

        async function syncLoop() {
            const int = setInterval(async () => {
                if (!duelActive) return clearInterval(int);
                try {
                    // Update my score
                    const myScore = isPlayer1 ? p1Score : p2Score;
                    if (isPlayer1) {
                        await sql`UPDATE duels SET player1_score = ${myScore} WHERE id = ${duelId}`;
                    } else {
                        await sql`UPDATE duels SET player2_score = ${myScore} WHERE id = ${duelId}`;
                    }

                    // Fetch opponent score
                    const res = await sql`SELECT player1_score, player2_score, status FROM duels WHERE id = ${duelId}`;
                    if (res[0].status === 'finished') {
                        duelActive = false;
                        finishDuel();
                        return;
                    }
                    p1Score = res[0].player1_score;
                    p2Score = res[0].player2_score;

                    get('p1-score-display').textContent = p1Score;
                    get('p2-score-display').textContent = p2Score;
                } catch (e) { }
            }, 2000);
        }

        // Mini Game Logic
        const cloth = get('cloth');
        let x = window.innerWidth / 2, y = window.innerHeight / 2;

        document.body.onmousemove = (e) => {
            x = e.clientX;
            y = e.clientY;
            cloth.style.left = `${x - 100}px`;
            cloth.style.top = `${y - 100}px`;
            checkClean(x, y);
        };

        function spawnStainsLoop() {
            if (!duelActive) return;
            const area = isPlayer1 ? get('p1-area') : get('p2-area');
            const stain = document.createElement('div');
            stain.className = 'stain';
            stain.style.width = '60px';
            stain.style.height = '60px';
            stain.style.background = `hsl(${Math.random() * 360}, 50%, 50%)`;
            stain.style.left = `${Math.random() * 80}%`;
            stain.style.top = `${Math.random() * 80}%`;
            stain.style.pointerEvents = 'none';
            stain.style.filter = 'blur(5px)';
            area.appendChild(stain);

            setTimeout(spawnStainsLoop, 1000 - ((p1Score + p2Score) * 0.1));
        }

        function checkClean(mx, my) {
            if (!duelActive) return;
            const areaId = isPlayer1 ? 'p1-area' : 'p2-area';
            const area = get(areaId);
            const stains = area.querySelectorAll('.stain');

            stains.forEach(s => {
                const rect = s.getBoundingClientRect();
                const dist = Math.hypot(mx - (rect.left + 30), my - (rect.top + 30));
                if (dist < 80) {
                    s.remove();
                    if (isPlayer1) p1Score++; else p2Score++;
                    updateLocalUI();
                }
            });
        }

        function updateLocalUI() {
            get('p1-score-display').textContent = p1Score;
            get('p2-score-display').textContent = p2Score;
        }

        async function finishDuel() {
            duelActive = false;
            const winner = p1Score > p2Score ? duelData.player1_email : duelData.player2_email;
            const isWinner = (userEmail === winner);
            const totalPrize = Math.floor((p1Score + p2Score) * 0.5);

            get('winner-modal').classList.remove('hidden');
            get('winner-text').textContent = isWinner ? "·Éó·É•·Éï·Éî·Éú ·Éí·Éê·Éò·Éõ·Éê·É†·ÉØ·Éï·Éî·Éó! üéâ" : "·Éó·É•·Éï·Éî·Éú ·É¨·Éê·Éê·Éí·Éî·Éó... üìâ";
            get('winner-reward-text').textContent = isWinner ? `·Éû·É†·Éò·Éñ·Éò: ${totalPrize} ü™ô` : "·É®·Éî·Éõ·Éì·Éî·Éí·É®·Éò ·É£·Éô·Éî·Éó·Éî·É°·Éê·Éì!";

            if (isWinner) {
                await sql`UPDATE users SET coins = coins + ${totalPrize}, total_coins = total_coins + ${totalPrize} WHERE email = ${userEmail}`;
            }
            await sql`UPDATE duels SET status = 'finished', winner_email = ${winner} WHERE id = ${duelId}`;
        }

        window.exitDuel = () => {
            window.location.href = 'index.html';
        };

        window.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            x = touch.clientX; y = touch.clientY;
            cloth.style.left = `${x - 100}px`;
            cloth.style.top = `${y - 100}px`;
            checkClean(x, y);
        });

        window.addEventListener('touchmove', (e) => {
            const touch = e.touches[0];
            x = touch.clientX; y = touch.clientY;
            cloth.style.left = `${x - 100}px`;
            cloth.style.top = `${y - 100}px`;
            checkClean(x, y);
        });

        initDuel();
    </script>
</body>

</html>